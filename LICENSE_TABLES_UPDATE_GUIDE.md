# دليل تحديث جداول الترخيص في Supabase

## الخطوات المطلوبة لتطبيق التحديثات:

### 1. تطبيق التحديثات في قاعدة بيانات Supabase

قم بتشغيل الأوامر SQL التالية في Supabase SQL Editor:

```sql
-- نسخ محتوى ملف license_tables_setup.sql وتشغيله
```

أو يمكنك:
1. فتح Supabase Dashboard
2. الانتقال إلى SQL Editor
3. نسخ محتوى ملف `license_tables_setup.sql`
4. تشغيل الأوامر

### 2. إعادة تشغيل build_runner

```bash
dart run build_runner build --delete-conflicting-outputs
```

### 3. التحقق من أن الجداول تم إنشاؤها

في Supabase Dashboard:
- Table Editor
- تأكد من وجود الجداول التالية:
  - `license_status_view`
  - `license_stats_view`

### 4. اختبار النظام

1. تشغيل التطبيق
2. فتح Dashboard
3. التحقق من الرسائل في Console:
   - `✅ تم تحديث جدول license_status_view بنجاح`
   - `✅ تم تحديث جدول license_stats_view بنجاح`
   - `✅ تمت المزامنة مع Supabase بنجاح`

## المزايا الجديدة:

### 1. العمل بدون إنترنت
- يمكن استخدام التطبيق لمدة 7 أيام بدون اتصال
- يتم حفظ حالة الترخيص محلياً
- المزامنة التلقائية عند توفر الإنترنت

### 2. مؤشر الحالة
- عرض مؤشر "بدون إنترنت" في شريط التطبيق
- ألوان مختلفة لحالات الترخيص المختلفة

### 3. قاعدة البيانات المحسنة
- جداول محلية للترخيص باستخدام Isar
- جداول سحابية في Supabase للنسخ الاحتياطي
- مزامنة تلقائية بين المحلي والسحابي

### 4. المراقبة والتشخيص
- رسائل تشخيصية مفصلة في Console
- تتبع حالة الترخيص بدقة
- معالجة أخطاء الاتصال

## استكشاف الأخطاء:

### إذا لم تظهر الجداول في Supabase:
1. تأكد من تشغيل SQL commands بنجاح
2. تحقق من صلاحيات المستخدم
3. تأكد من تفعيل RLS

### إذا ظهرت أخطاء في التطبيق:
1. تأكد من تشغيل build_runner
2. تحقق من صحة imports
3. تأكد من تطابق أسماء الجداول

### إذا لم تعمل المزامنة:
1. تحقق من اتصال الإنترنت
2. تأكد من صحة Supabase credentials
3. تحقق من وجود معرف المدرسة

## ملاحظات مهمة:

- النظام يعمل محلياً حتى لو فشلت المزامنة مع Supabase
- يتم تخزين آخر حالة ترخيص محلياً لمدة 7 أيام
- المزامنة تحدث تلقائياً عند فتح Dashboard
- يمكن تخصيص فترة العمل بدون إنترنت من خلال AppSettings
